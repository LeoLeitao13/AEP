<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa Maringá</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: sans-serif;
    }

    #map {
      float: left;
      width: 75%;
      height: 100vh;
    }

    #sidebar {
      float: right;
      width: 25%;
      height: 100vh;
      background-color: #f0f0f0;
      padding: 15px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    input, button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div id="sidebar">
  <h3>Rotas Seguras - Maringá</h3>
  <label>Origem:</label>
  <input type="text" id="origemInput" placeholder="Digite um endereço em Maringá">
  <label>Destino:</label>
  <input type="text" id="destinoInput" placeholder="Digite um endereço em Maringá">
  <button onclick="buscarCoordenadas()">Traçar Rota</button>
  <button onclick="limparMapa()">Limpar Mapa</button>
  <button onclick="chamarRelatorio()">Ver Avaliações</button>

  <hr>
  <h4>Avaliação do trecho</h4>
  <label>Segurança:</label>
  <input id="seg" type="number" min="0" max="5">
  <label>Iluminação:</label>
  <input id="ilu" type="number" min="0" max="5">
  <label>Tráfego:</label>
  <input id="traf" type="number" min="0" max="5">
  <button onclick="enviarAvaliacao()">Enviar Avaliação</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let bounds = L.latLngBounds(L.latLng(-23.45, -51.97), L.latLng(-23.39, -51.88));
  let map = L.map('map', { minZoom: 13, maxZoom: 17, maxBounds: bounds })
          .setView([-23.4208, -51.9331], 14);

  map.on('drag', () => map.panInsideBounds(bounds, { animate: false }));

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  let origem = null, destino = null, rotaLayer = null;

  map.on('click', function(e) {
    if (!origem) {
      origem = e.latlng;
      L.marker(origem).addTo(map).bindPopup("Origem").openPopup();
    } else if (!destino) {
      destino = e.latlng;
      L.marker(destino).addTo(map).bindPopup("Destino").openPopup();
      calcularRota();
    }
  });

  function buscarCoordenadas() {
    const origemTexto = document.getElementById('origemInput').value;
    const destinoTexto = document.getElementById('destinoInput').value;

    Promise.all([geocodificar(origemTexto), geocodificar(destinoTexto)]).then(([origemCoord, destinoCoord]) => {
      origem = origemCoord;
      destino = destinoCoord;
      L.marker(origem).addTo(map).bindPopup("Origem").openPopup();
      L.marker(destino).addTo(map).bindPopup("Destino").openPopup();
      map.setView(origem, 14);
      calcularRota();
    });
  }

  function geocodificar(endereco) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}`;
    return fetch(url)
            .then(res => res.json())
            .then(data => {
              if (!data || data.length === 0 || !data[0].display_name.includes("Maring")) {
                alert("O endereço precisa estar dentro de Maringá - PR.");
                throw new Error("Fora de Maringá");
              }
              return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
            });
  }

  function calcularRota() {
    const url = `https://router.project-osrm.org/route/v1/foot/${origem.lng},${origem.lat};${destino.lng},${destino.lat}?overview=full&geometries=geojson`;
    fetch(url)
            .then(res => res.json())
            .then(data => {
              const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);
              if (rotaLayer) map.removeLayer(rotaLayer);
              rotaLayer = L.polyline(coords, {color: 'blue'}).addTo(map);
            });
  }

  function enviarAvaliacao() {
    const dados = {
      origem: document.getElementById('origemInput').value || "Coordenada",
      destino: document.getElementById('destinoInput').value || "Coordenada",
      seguranca: document.getElementById('seg').value,
      iluminacao: document.getElementById('ilu').value,
      trafego: document.getElementById('traf').value
    };
    if (window.javaConnector) {
      window.javaConnector.receberAvaliacao(JSON.stringify(dados));
    }
    alert("Avaliação enviada com sucesso!");
  }

  function limparMapa() {
    map.eachLayer((layer) => {
      if (layer instanceof L.Marker || layer instanceof L.Polyline) {
        map.removeLayer(layer);
      }
    });
    origem = null;
    destino = null;
    rotaLayer = null;
  }

  function chamarRelatorio() {
    if (window.javaConnector) {
      window.javaConnector.mostrarRelatorioEmJanela();
    } else {
      alert("Conector Java não disponível.");
    }
  }

  setTimeout(() => map.invalidateSize(), 500);
</script>
</body>
</html>
